!function(a){"use strict";a.fn.mapael=function(b){return b=a.extend(!0,{},a.fn.mapael.defaultOptions,b),this.each(function(){var c=a(this),d=a("<div>").addClass(b.map.tooltip.cssClass).css("display","none"),e=a("."+b.map.cssClass,this).empty().append(d),f=a.fn.mapael.maps[b.map.name],g=new Raphael(e[0],f.width,f.height),h={},i=0,j={},k={},l={},m={},n=0,o={},p=[];b.map.tooltip.css&&d.css(b.map.tooltip.css),g.setViewBox(0,0,f.width,f.height,!1);for(n in f.elems)h=a.fn.mapael.getElemOptions(b.map.defaultArea,b.areas[n]?b.areas[n]:{},b.legend.area),j[n]={mapElem:g.path(f.elems[n]).attr(h.attrs)};for(n in f.elems)h=a.fn.mapael.getElemOptions(b.map.defaultArea,b.areas[n]?b.areas[n]:{},b.legend.area),a.fn.mapael.initElem(g,j[n],h,d,n);for(n in b.plots)k[n]=a.fn.mapael.drawPlot(n,b,f,g,d);if(c.on("zoom",function(a,d,e,h){var i=Math.min(Math.max(d,0),b.map.zoom.maxLevel);c.data("zoomLevel",i),"undefined"==typeof e&&(e=g._viewBox[0]+g._viewBox[2]/2),"undefined"==typeof h&&(h=g._viewBox[1]+g._viewBox[3]/2),0==i?g.setViewBox(0,0,f.width,f.height):g.setViewBox(Math.min(Math.max(0,e-f.width/(1+i*b.map.zoom.step)/2),f.width-f.width/(1+i*b.map.zoom.step)),Math.min(Math.max(0,h-f.height/(1+i*b.map.zoom.step)/2),f.height-f.height/(1+i*b.map.zoom.step)),f.width/(1+i*b.map.zoom.step),f.height/(1+i*b.map.zoom.step))}),b.map.zoom.enabled&&a.fn.mapael.initZoom(e,g,f.width,f.height,b.map.zoom),"undefined"!=typeof b.map.zoom.init&&(b.map.zoom.init.latitude&&b.map.zoom.init.longitude?(o=f.getCoords(b.map.zoom.init.latitude,b.map.zoom.init.longitude),p=[b.map.zoom.init.level,o.x,o.y]):p="undefined"!=typeof b.map.zoom.init.x&&"undefined"!=typeof b.map.zoom.init.y?[b.map.zoom.init.level,b.map.zoom.init.x,b.map.zoom.init.y]:[b.map.zoom.init.level],c.trigger("zoom",p)),b.legend.area.slices&&b.legend.area.display&&(l=a.fn.mapael.createLegend(c,b,"area",j,1)),c.on("update",function(e,h,i,n,o){var p=0,q=0,r=0,s={},t=function(b){"undefined"!=typeof b.hidden&&1==b.hidden&&a(b.node).trigger("click")};if(l.forEach&&l.forEach(t),m.forEach&&m.forEach(t),"undefined"!=typeof o&&(o.resetAreas&&(b.areas={}),o.resetPlots&&(b.plots={}),o.animDuration&&(r=o.animDuration)),a.extend(!0,b,h),"object"==typeof n)for(;p<n.length;p++)"undefined"!=typeof k[n[p]]&&(r>0?!function(a){a.mapElem.animate({opacity:0},r,"linear",function(){a.mapElem.remove()}),a.textElem&&a.textElem.animate({opacity:0},r,"linear",function(){a.textElem.remove()})}(k[n[p]]):(k[n[p]].mapElem.remove(),k[n[p]].textElem&&k[n[p]].textElem.remove()),delete k[n[p]]);if("object"==typeof i)for(q in i)"undefined"==typeof k[q]&&(b.plots[q]=i[q],k[q]=a.fn.mapael.drawPlot(q,b,f,g,d),r>0&&(k[q].mapElem.attr({opacity:0}),k[q].textElem.attr({opacity:0}),k[q].mapElem.animate({opacity:"undefined"!=typeof k[q].mapElem.originalAttrs.opacity?k[q].mapElem.originalAttrs.opacity:1},r),k[q].textElem.animate({opacity:"undefined"!=typeof k[q].textElem.originalAttrs.opacity?k[q].textElem.originalAttrs.opacity:1},r)));for(q in j)s=a.fn.mapael.getElemOptions(b.map.defaultArea,b.areas[q]?b.areas[q]:{},b.legend.area),a.fn.mapael.updateElem(s,j[q],d,r);for(q in k)s=a.fn.mapael.getElemOptions(b.map.defaultPlot,b.plots[q]?b.plots[q]:{},b.legend.plot),"square"==s.type?(s.attrs.width=s.size,s.attrs.height=s.size,s.attrs.x=k[q].mapElem.attrs.x-(s.size-k[q].mapElem.attrs.width)/2,s.attrs.y=k[q].mapElem.attrs.y-(s.size-k[q].mapElem.attrs.height)/2):"image"==s.type?(s.attrs.x=k[q].mapElem.attrs.x-(s.width-k[q].mapElem.attrs.width)/2,s.attrs.y=k[q].mapElem.attrs.y-(s.height-k[q].mapElem.attrs.height)/2):s.attrs.r=s.size/2,a.fn.mapael.updateElem(s,k[q],d,r);"undefined"!=typeof o&&o.afterUpdate&&o.afterUpdate(c,g,j,k,b)}),b.map.width)g.setSize(b.map.width,f.height*(b.map.width/f.width)),b.legend.plot.slices&&b.legend.plot.display&&(m=a.fn.mapael.createLegend(c,b,"plot",k,b.map.width/f.width));else{a(window).on("resize",function(){clearTimeout(i),i=setTimeout(function(){e.trigger("resizeEnd")},150)});var q=function(){b.legend.plot.slices&&b.legend.plot.display&&(m=a.fn.mapael.createLegend(c,b,"plot",k,e.width()/f.width)),e.unbind("resizeEnd",q)};e.on("resizeEnd",function(){var a=e.width();g.width!=a&&g.setSize(a,f.height*(a/f.width))}).on("resizeEnd",q).trigger("resizeEnd")}b.map.afterInit&&b.map.afterInit(c,g,j,k,b),a(g.desc).append(" and Mapael (http://neveldo.fr/mapael)")})},a.fn.mapael.initElem=function(b,c,d,e,f){var g={},h={};a.fn.mapael.setHoverOptions(c.mapElem,d.attrs,d.attrsHover),d.text&&"undefined"!=typeof d.text.content?(g=c.mapElem.getBBox(),h=a.fn.mapael.getTextPosition(g,d.text.position,d.text.margin),d.text.attrs["text-anchor"]=h.textAnchor,c.textElem=b.text(h.x,h.y,d.text.content).attr(d.text.attrs),a.fn.mapael.setHoverOptions(c.textElem,d.text.attrs,d.text.attrsHover),a.fn.mapael.setHover(b,c.mapElem,c.textElem),d.eventHandlers&&a.fn.mapael.setEventHandlers(f,d,c.mapElem,c.textElem),a(c.textElem.node).attr("data-id",f)):(a.fn.mapael.setHover(b,c.mapElem),d.eventHandlers&&a.fn.mapael.setEventHandlers(f,d,c.mapElem)),d.tooltip&&d.tooltip.content&&(c.mapElem.tooltipContent=d.tooltip.content,a.fn.mapael.setTooltip(c.mapElem,e),d.text&&"undefined"!=typeof d.text.content&&(c.textElem.tooltipContent=d.tooltip.content,a.fn.mapael.setTooltip(c.textElem,e))),d.href&&(c.mapElem.href=d.href,c.mapElem.target=d.target,a.fn.mapael.setHref(c.mapElem),d.text&&"undefined"!=typeof d.text.content&&(c.textElem.href=d.href,c.textElem.target=d.target,a.fn.mapael.setHref(c.textElem))),"undefined"!=typeof d.value&&(c.value=d.value),a(c.mapElem.node).attr("data-id",f)},a.fn.mapael.updateElem=function(b,c,d,e){var f,g,h;"undefined"!=typeof b.value&&(c.value=b.value),c.textElem&&("undefined"!=typeof b.text&&"undefined"!=typeof b.text.content&&b.text.content!=c.textElem.attrs.text&&c.textElem.attr({text:b.text.content}),f=c.mapElem.getBBox(),b.size&&(h=(b.size-f.height)/2,f.x-=h,f.x2+=h,f.y-=h,f.y2+=h),g=a.fn.mapael.getTextPosition(f,b.text.position,b.text.margin),(g.x!=c.textElem.attrs.x||g.y!=c.textElem.attrs.y)&&(e>0?(c.textElem.attr({"text-anchor":g.textAnchor}),c.textElem.animate({x:g.x,y:g.y},e)):c.textElem.attr({x:g.x,y:g.y,"text-anchor":g.textAnchor})),a.fn.mapael.setHoverOptions(c.textElem,b.text.attrs,b.text.attrsHover),e>0?c.textElem.animate(b.text.attrs,e):c.textElem.attr(b.text.attrs)),a.fn.mapael.setHoverOptions(c.mapElem,b.attrs,b.attrsHover),e>0?c.mapElem.animate(b.attrs,e):c.mapElem.attr(b.attrs),b.tooltip&&"undefined"!=typeof b.tooltip.content&&("undefined"==typeof c.mapElem.tooltipContent&&(a.fn.mapael.setTooltip(c.mapElem,d),c.textElem&&a.fn.mapael.setTooltip(c.textElem,d)),c.mapElem.tooltipContent=b.tooltip.content,c.textElem&&(c.textElem.tooltipContent=b.tooltip.content)),"undefined"!=typeof b.href&&("undefined"==typeof c.mapElem.href&&(a.fn.mapael.setHref(c.mapElem),c.textElem&&a.fn.mapael.setHref(c.textElem)),c.mapElem.href=b.href,c.mapElem.target=b.target,c.textElem&&(c.textElem.href=b.href,c.textElem.target=b.target))},a.fn.mapael.drawPlot=function(b,c,d,e,f){var g={},h={},i=a.fn.mapael.getElemOptions(c.map.defaultPlot,c.plots[b]?c.plots[b]:{},c.legend.plot);return h="undefined"!=typeof i.x&&"undefined"!=typeof i.y?{x:i.x,y:i.y}:d.getCoords(i.latitude,i.longitude),g="square"==i.type?{mapElem:e.rect(h.x-i.size/2,h.y-i.size/2,i.size,i.size).attr(i.attrs)}:"image"==i.type?{mapElem:e.image(i.url,h.x-i.width/2,h.y-i.height/2,i.width,i.height).attr(i.attrs)}:{mapElem:e.circle(h.x,h.y,i.size/2).attr(i.attrs)},a.fn.mapael.initElem(e,g,i,f,b),g},a.fn.mapael.setHref=function(b){b.attr({cursor:"pointer"}),a(b.node).bind("click",function(){!a.fn.mapael.panning&&b.href&&window.open(b.href,b.target)})},a.fn.mapael.setTooltip=function(b,c){var d=0,e=c.parent(),f=e.offset().left+e.width();a(b.node).on("mouseover",function(e){d=setTimeout(function(){b.tooltipContent&&c.html(b.tooltipContent).css("display","block"),c.css({left:Math.min(f-c.outerWidth()-5,e.pageX+12),top:e.pageY+23-a(window).scrollTop()})},120)}).on("mouseout",function(){clearTimeout(d),c.css("display","none")}).on("mousemove",function(b){c.css({left:Math.min(f-c.outerWidth()-5,b.pageX+12),top:b.pageY+23-a(window).scrollTop()})})},a.fn.mapael.setEventHandlers=function(b,c,d,e){for(var f in c.eventHandlers)!function(f){a(d.node).on(f,function(g){!a.fn.mapael.panning&&c.eventHandlers[f](g,b,d,e)}),e&&a(e.node).on(f,function(g){!a.fn.mapael.panning&&c.eventHandlers[f](g,b,d,e)})}(f)},a.fn.mapael.panning=!1,a.fn.mapael.initZoom=function(b,c,d,e,f){var g=b.parent(),h=a("<div>").addClass(f.zoomInCssClass).html("+"),i=a("<div>").addClass(f.zoomOutCssClass).html("&#x2212;"),j=!1,k=0,l=0;g.data("zoomLevel",0),b.append(h).append(i),h.on("click",function(){g.trigger("zoom",g.data("zoomLevel")+1)}),i.on("click",function(){g.trigger("zoom",g.data("zoomLevel")-1)}),a("body").on("mouseup",function(){j=!1,setTimeout(function(){a.fn.mapael.panning=!1},50)}),b.on("mousedown",function(a){return j=!0,k=a.pageX,l=a.pageY,!1}).on("mousemove",function(b){var h=g.data("zoomLevel");if(j&&0!=h){var i=(k-b.pageX)/(1+h*f.step)*(d/c.width),m=(l-b.pageY)/(1+h*f.step)*(e/c.height);(Math.abs(i)>5||Math.abs(m)>5)&&(c.setViewBox(Math.min(Math.max(0,c._viewBox[0]+i),d-c._viewBox[2]),Math.min(Math.max(0,c._viewBox[1]+m),e-c._viewBox[3]),c._viewBox[2],c._viewBox[3]),k=b.pageX,l=b.pageY,a.fn.mapael.panning=!0)}return!1})},a.fn.mapael.createLegend=function(b,c,d,e,f){var g=c.legend[d],h="plot"==d?a("."+c.legend.plot.cssClass,b).empty():a("."+c.legend.area.cssClass,b).empty(),i=new Raphael(h.get(0)),j=0,k=0,l={},m={},n={},o={},p={},q=0,r=0,s=0,t=0;for(g.title&&(l=i.text(g.marginLeftTitle,0,g.title).attr(g.titleAttrs),l.attr({y:.5*l.getBBox().height}),j=g.marginLeftTitle+l.getBBox().width,k+=g.marginBottomTitle+l.getBBox().height),q=0,length=g.slices.length;length>q;++q)"area"!=d||g.slices[q].width||(g.slices[q].width=30),"area"!=d||g.slices[q].height||(g.slices[q].height=20),t="image"==g.slices[q].type||"area"==d?Math.max(t,g.marginBottomTitle+l.getBBox().height+f*g.slices[q].height/2):Math.max(t,g.marginBottomTitle+l.getBBox().height+f*g.slices[q].size/2);for("horizontal"==g.mode&&(j=g.marginLeft),q=0,length=g.slices.length;length>q;++q)("undefined"==typeof g.slices[q].display||1==g.slices[q].display)&&(m="plot"==d?c.map.defaultPlot:c.map.defaultArea,g.slices[q].attrs=a.extend({},m.attrs,g.slices[q].attrs),g.slices[q].attrsHover=a.extend({},m.attrsHover,g.slices[q].attrsHover),"area"==d?("horizontal"==g.mode?(r=j+g.marginLeft,s=t-.5*f*g.slices[q].height):(r=g.marginLeft,s=k),n=i.rect(r,s,f*g.slices[q].width,f*g.slices[q].height).attr(g.slices[q].attrs)):"square"==g.slices[q].type?("horizontal"==g.mode?(r=j+g.marginLeft,s=t-.5*f*g.slices[q].size):(r=g.marginLeft,s=k),n=i.rect(r,s,f*g.slices[q].size,f*g.slices[q].size).attr(g.slices[q].attrs)):"image"==g.slices[q].type?("horizontal"==g.mode?(r=j+g.marginLeft,s=t-.5*f*g.slices[q].height):(r=g.marginLeft,s=k),n=i.image(g.slices[q].url,r,s,f*g.slices[q].width,f*g.slices[q].height).attr(g.slices[q].attrs)):("horizontal"==g.mode?(r=j+g.marginLeft+f*(g.slices[q].size/2),s=t):(r=g.marginLeft+f*(g.slices[q].size/2),s=k+f*(g.slices[q].size/2)),n=i.circle(r,s,f*(g.slices[q].size/2)).attr(g.slices[q].attrs)),o=n.getBBox(),"horizontal"==g.mode?(r=j+g.marginLeft+o.width+g.marginLeftLabel,s=t):(r=g.marginLeft+o.width+g.marginLeftLabel,s=k+o.height/2),p=i.text(r,s,g.slices[q].label).attr(g.labelAttrs),"horizontal"==g.mode?(j+=g.marginLeft+o.width+g.marginLeftLabel+p.getBBox().width,k="image"==g.slices[q].type||"area"==d?Math.max(k,g.marginBottom+l.getBBox().height+f*g.slices[q].height):Math.max(k,g.marginBottomTitle+l.getBBox().height+f*g.slices[q].size)):(j=Math.max(j,g.marginLeft+o.width+g.marginLeftLabel+p.getBBox().width),k+=g.marginBottom+o.height),a(n.node).attr({"data-type":"elem","data-index":q}),a(p.node).attr({"data-type":"label","data-index":q}),g.hideElemsOnClick.enabled&&(p.attr({cursor:"pointer"}),a.fn.mapael.setHoverOptions(n,g.slices[q].attrs,g.slices[q].attrs),a.fn.mapael.setHoverOptions(p,g.labelAttrs,g.labelAttrsHover),a.fn.mapael.setHover(i,n,p),p.hidden=!1,function(b,c,d){a(d.node).on("click",function(){d.hidden?d.animate({opacity:1},300):d.animate({opacity:.5},300);for(var a in e)("undefined"!=typeof g.slices[b].value&&e[a].value==g.slices[b].value||"undefined"==typeof g.slices[b].value&&("undefined"==typeof g.slices[b].min||e[a].value>=g.slices[b].min)&&("undefined"==typeof g.slices[b].max||e[a].value<g.slices[b].max))&&!function(a){d.hidden?(0==g.hideElemsOnClick.opacity&&(e[a].mapElem.show(),e[a].textElem&&e[a].textElem.show()),e[a].mapElem.animate({opacity:"undefined"!=typeof e[a].mapElem.originalAttrs.opacity?e[a].mapElem.originalAttrs.opacity:1},300),e[a].textElem&&e[a].textElem.animate({opacity:"undefined"!=typeof e[a].textElem.originalAttrs.opacity?e[a].textElem.originalAttrs.opacity:1},300)):(e[a].mapElem.animate({opacity:g.hideElemsOnClick.opacity},300,"linear",function(){0==g.hideElemsOnClick.opacity&&e[a].mapElem.hide()}),e[a].textElem&&e[a].textElem.animate({opacity:g.hideElemsOnClick.opacity},300,"linear",function(){0==g.hideElemsOnClick.opacity&&e[a].textElem.hide()}))}(a);d.hidden=!d.hidden})}(q,n,p)));return"SVG"!=Raphael.type&&g.VMLWidth&&(j=g.VMLWidth),i.setSize(j,k),i},a.fn.mapael.setHoverOptions=function(b,c,d){"SVG"!=Raphael.type&&delete d.transform,b.attrsHover=d,b.originalAttrs=b.attrsHover.transform?a.extend({transform:"s1"},c):c},a.fn.mapael.setHover=function(b,c,d){var e={},f={},g=0,h=function(){g=setTimeout(function(){a.fn.mapael.elemHover(b,c,d)},120)},i=function(){clearTimeout(g),a.fn.mapael.elemOut(b,c,d)};e=a(c.node),e.on("mouseover",h),e.on("mouseout",i),d&&(f=a(d.node),f.on("mouseover",h),a(d.node).on("mouseout",i))},a.fn.mapael.elemHover=function(a,b,c){b.animate(b.attrsHover,b.attrsHover.animDuration),c&&c.animate(c.attrsHover,c.attrsHover.animDuration),a.safari()},a.fn.mapael.elemOut=function(a,b,c){b.animate(b.originalAttrs,b.attrsHover.animDuration),c&&c.animate(c.originalAttrs,c.attrsHover.animDuration),a.safari()},a.fn.mapael.getElemOptions=function(b,c,d){var e=a.extend(!0,{},b,c);return"undefined"!=typeof e.value&&a.extend(!0,e,a.fn.mapael.getLegendSlice(e.value,d)),e},a.fn.mapael.getTextPosition=function(a,b,c){var d=0,e=0,f="";switch(b){case"bottom":d=(a.x+a.x2)/2,e=a.y2+c,f="middle";break;case"top":d=(a.x+a.x2)/2,e=a.y-c,f="middle";break;case"left":d=a.x-c,e=(a.y+a.y2)/2,f="end";break;case"right":d=a.x2+c,e=(a.y+a.y2)/2,f="start";break;default:d=(a.x+a.x2)/2,e=(a.y+a.y2)/2,f="middle"}return{x:d,y:e,textAnchor:f}},a.fn.mapael.getLegendSlice=function(a,b){for(var c=0,d=b.slices.length;d>c;++c)if("undefined"!=typeof b.slices[c].value&&a==b.slices[c].value||"undefined"==typeof b.slices[c].value&&("undefined"==typeof b.slices[c].min||a>=b.slices[c].min)&&("undefined"==typeof b.slices[c].max||a<b.slices[c].max))return b.slices[c];return{}},a.fn.mapael.defaultOptions={map:{cssClass:"map",tooltip:{cssClass:"mapTooltip"},defaultArea:{attrs:{fill:"#343434",stroke:"#5d5d5d","stroke-width":1,"stroke-linejoin":"round"},attrsHover:{fill:"#f38a03",animDuration:300},text:{position:"inner",margin:10,attrs:{"font-size":15,fill:"#c7c7c7"},attrsHover:{fill:"#eaeaea",animDuration:300}},target:"_self"},defaultPlot:{type:"circle",size:15,attrs:{fill:"#0088db",stroke:"#fff","stroke-width":0,"stroke-linejoin":"round"},attrsHover:{"stroke-width":3,animDuration:300},text:{position:"right",margin:10,attrs:{"font-size":15,fill:"#c7c7c7"},attrsHover:{fill:"#eaeaea",animDuration:300}},target:"_self"},zoom:{enabled:!1,maxLevel:5,step:.25,zoomInCssClass:"zoomIn",zoomOutCssClass:"zoomOut"}},legend:{area:{cssClass:"areaLegend",display:!1,marginLeft:15,marginLeftTitle:5,marginBottomTitle:15,marginLeftLabel:10,marginBottom:15,titleAttrs:{"font-size":18,fill:"#343434","text-anchor":"start"},labelAttrs:{"font-size":15,fill:"#343434","text-anchor":"start"},labelAttrsHover:{fill:"#787878",animDuration:300},hideElemsOnClick:{enabled:!0,opacity:.2},slices:[],mode:"vertical"},plot:{cssClass:"plotLegend",display:!1,marginLeft:15,marginLeftTitle:5,marginBottomTitle:15,marginLeftLabel:10,marginBottom:15,titleAttrs:{"font-size":18,fill:"#343434","text-anchor":"start"},labelAttrs:{"font-size":15,fill:"#343434","text-anchor":"start"},labelAttrsHover:{fill:"#787878",animDuration:300},hideElemsOnClick:{enabled:!0,opacity:.2},slices:[],mode:"vertical"}},areas:{},plots:{}}}(jQuery);